# Underground Explorer (地下探索者) - 设计文档

## 项目概述

一款网页端第一人称地下探索游戏，使用 Three.js 构建的体素世界，包含程序化地形生成、冒险战斗、队友 NPC 系统和多层地下世界探索。

## 技术栈

| 技术 | 用途 |
|------|------|
| TypeScript | 主要开发语言 |
| Vite | 构建工具，热更新 |
| Three.js | 3D 渲染引擎 |
| simplex-noise | 程序化地形生成 |
| IndexedDB | 本地存档 |

## 核心架构

```
src/
├── core/          # 游戏核心循环、时间管理
├── world/         # 地形生成、区块管理、方块系统
├── player/        # 第一人称控制、物理、背包
├── combat/        # 武器系统、伤害计算
├── entities/      # 敌人 AI、Boss 行为
├── npc/           # 队友 NPC、AI、指挥系统
├── ui/            # HUD、菜单、背包界面
└── save/          # 存档读写
```

## 世界与地形系统

### 程序化生成策略
- 使用 3D Simplex 噪声生成基础地形密度
- 分层设计：每层有独特的基调和生成规则
- 洞穴系统：使用元胞自动机生成自然洞穴网络

### 深度层级设计 (15 层)

| 深度 | 名称 | 特点 | 敌人类型 |
|-----|------|------|---------|
| 1-3 | 泥土层 | 宽敞洞穴，光线较亮 | 史莱姆、蝙蝠 |
| 4-6 | 石头层 | 狭窄隧道，需要照明 | 骷髅、地底虫 |
| 7-9 | 深岩层 | 更硬的石头，稀有矿石 | 石巨人、暗影怪 |
| 10-12 | 危机层 | 危险环境，精英怪频繁 | 火焰蝙蝠、熔岩怪 |
| 13-15 | 深渊层 | Boss 区域，古代遗迹 | 深渊守卫、最终 Boss |

### 特殊区域（隐藏层）
- 水晶洞穴：发光水晶，稀有用
- 古代遗迹：可以招募 NPC 的地点
- 地下湖：需要特殊装备穿越

### 方块类型 (8 种)
1. 泥土 - 易挖掘
2. 石头 - 基础建材
3. 深岩 - 需要更好工具
4. 铜矿 - 制作基础武器
5. 铁矿 - 制作进阶武器
6. 宝石 - 稀有资源
7. 宝箱 - 随机战利品
8. 古代石块 - 遗迹专用

## 玩家系统

- 第一人称控制器（WASD 移动 + 鼠标视角）
- 物理系统：重力、跳跃、碰撞检测
- 生命值 + 护甲系统
- 背包系统：快捷栏 6 格 + 背包 24 格

## 队友 NPC 系统

### 招募机制
- 在地下遗迹/洞穴中营救被困 NPC
- 每个 NPC 有独特背景和战斗风格
- 最多同时 3 个队友跟随

### 指挥系统

| 指令 | 行为 |
|-----|------|
| 跟随 | 保持队形跟随玩家 |
| 攻击目标 | 指定攻击特定敌人 |
| 防守位置 | 在指定位置待命并攻击靠近的敌人 |
| 收集资源 | 自动拾取附近掉落物 |
| 撤退 | 返回玩家身边 |

### 队友 AI
- 寻路系统：A* 算法跟随玩家
- 战斗 AI：自动攻击范围内敌人
- 生存本能：生命值低时后退躲避
- 协作行为：不阻挡玩家视线和射击线

### 队友成长
- 跟随战斗获得经验
- 可分配武器/装备提升战斗力
- 随机性格影响战斗风格（激进/保守/支援）

## 战斗与武器系统

### 武器类型

| 武器类型 | 攻击方式 | 伤害 | 特点 |
|---------|---------|------|------|
| 镐 | 近战挥击 | 低 | 可挖掘可战斗，基础武器 |
| 剑 | 近战连击 | 中 | 攻速快，可连击 |
| 锤 | 近战重击 | 高 | 攻速慢，可击退敌人 |
| 弓 | 远程射击 | 中 | 需要箭矢，可蓄力 |
| 法杖 | 魔法攻击 | 中 | 范围伤害，消耗魔力 |

### 武器升级路线
```
铜剑 → 铁剑 → 精钢剑 → 古代合金剑
(每级提升 30% 伤害和耐久)
```

### 战斗机制
- 点击攻击，长按蓄力（远程武器）
- 攻击冷却系统，防止连点滥用
- 暴击系统：攻击敌人背部造成 1.5x 伤害
- 击退效果：重型武器可击退小型敌人

### 伤害计算
```
最终伤害 = 武器基础伤害 × (1 + 玩家攻击力) × 暴击倍率 × 敌人防御减免
```

### 敌人系统 (12 种)

**普通敌人**:
- 史莱姆、蝙蝠、骷髅、地底虫、暗影怪、火焰蝙蝠

**精英敌人**:
- 石巨人、熔岩怪、深渊守卫

**Boss (3 个)**:
- 巨型史莱姆王 (第 5 层)
- 远古石巨人 (第 10 层)
- 深渊领主 (第 15 层)

## UI 与存档系统

### HUD 界面
```
┌─────────────────────────────────────────┐
│ ❤️ 80/100   🛡️ 30   ⚡ 50/100    [小地图] │
│                                         │
│                                         │
│              [游戏画面]                   │
│                                         │
│                                         │
│  [快捷栏: 镐 | 剑 | 弓 | 药水 | 火把 | 空]  │
│    1      2     3      4      5     6   │
└─────────────────────────────────────────┘
```

### 菜单系统
- **主菜单**: 开始游戏、继续、设置、退出
- **暂停菜单**: 继续、保存、设置、返回主菜单
- **背包界面**: 装备栏、物品栏、制作栏
- **队友界面**: 查看队友状态、下达指令、装备管理

### 小地图
- 显示已探索区域轮廓
- 标记队友位置（绿点）、敌人位置（红点）
- 标记特殊地点（遗迹、宝箱）

### 存档数据结构
```typescript
interface SaveData {
  version: string;
  timestamp: number;
  player: {
    position: Vector3;
    health: number;
    inventory: Item[];
    equipment: Equipment;
  };
  teammates: Teammate[];
  world: {
    seed: number;
    exploredChunks: string[];
    modifiedBlocks: BlockModification[];
  };
  progress: {
    bossesDefeated: string[];
    npcsRescued: string[];
    deepestLevel: number;
  };
}
```

### 存档策略
- 自动保存：每 5 分钟
- 手动保存：暂停菜单中点击保存
- 多存档槽：支持 3 个存档位置

## MVP 与迭代路线

### MVP 核心功能 (第一版)

| 优先级 | 功能 | 描述 |
|-------|------|------|
| P0 | 基础渲染 | Three.js 场景、第一人称相机 |
| P0 | 玩家控制 | WASD 移动、鼠标视角、跳跃 |
| P0 | 地形生成 | 单层区块生成、基础挖掘 |
| P1 | 方块系统 | 4 种基础方块、放置/破坏 |
| P1 | 简单敌人 | 史莱姆 + 蝙蝠，基础 AI |
| P1 | 战斗系统 | 近战攻击、伤害计算 |
| P2 | 基础 UI | 生命条、快捷栏、准心 |

### 迭代计划

**Phase 1 (MVP) - 基础可玩**
- 核心移动和挖掘
- 简单敌人战斗
- 基础 UI

**Phase 2 - 世界扩展**
- 多层地形生成
- 更多方块类型
- 武器系统（3 种武器）
- 背包系统

**Phase 3 - 队友系统**
- NPC 招募机制
- 指挥系统
- 队友 AI 跟随
- 队友装备

**Phase 4 - 内容丰富**
- 更多敌人类型
- Boss 战斗
- 隐藏区域
- 存档系统

**Phase 5 - 打磨**
- 音效和音乐
- 粒子特效
- 平衡调整
- 性能优化
